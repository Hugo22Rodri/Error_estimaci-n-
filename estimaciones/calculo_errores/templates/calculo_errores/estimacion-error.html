{% extends 'calculo_errores/base.html' %}

{% block content %}
<div class="card">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0">Método de Estimación del Error</h4>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            
            {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
            {% endif %}
            
            <div class="mb-3">
                <label for="funcion" class="form-label">
                    Función de iteración g(x):
                    <i class="bi bi-info-circle info-icon" 
                       data-bs-toggle="tooltip" 
                       title="Función para iteración de punto fijo. Ej: math.cos(x)"></i>
                </label>
                <input type="text" class="form-control" name="funcion" 
                       value="{{ funcion|default:'math.cos(x)' }}" required>
                <div class="form-text">Ejemplos: math.cos(x), (x + 2/x)/2, math.exp(-x)</div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="x0" class="form-label">Valor inicial (x₀):</label>
                    <input type="number" step="any" class="form-control" name="x0" 
                           value="{{ x0|default:1 }}" required>
                </div>
                <div class="col-md-6">
                    <label for="tolerancia" class="form-label">Tolerancia (ε):</label>
                    <input type="number" step="any" min="1e-10" class="form-control" name="tolerancia" 
                           value="{{ tol|default:0.0001 }}" required>
                </div>
            </div>
            
            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-calculator"></i> Calcular
                </button>
            </div>
        </form>
    </div>
</div>

{% if iteraciones %}
<div class="card mt-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">Resultados de la Estimación del Error</h5>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-light">
                        <h6>Resumen</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <strong>Solución aproximada:</strong> {{ solucion|floatformat:6 }}
                            </li>
                            <li class="list-group-item">
                                <strong>Iteraciones realizadas:</strong> {{ num_iter }}
                            </li>
                            <li class="list-group-item">
                                <strong>Convergencia:</strong> 
                                {% if convergio %} 
                                    <span class="badge bg-success">Lograda</span>
                                {% else %} 
                                    <span class="badge bg-danger">No convergió</span>
                                {% endif %}
                            </li>
                            <li class="list-group-item">
                                <strong>Tolerancia alcanzada:</strong> 
                                {{ iteraciones|last.error_abs|floatformat:6 }} ≤ {{ tol }}
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-light">
                        <h6>Gráfico de Convergencia</h6>
                    </div>
                    <div class="card-body">
                        <div id="grafico-convergencia" style="height: 200px;">
                            <p class="text-center text-muted">
                                <i class="bi bi-bar-chart"></i> Gráfico no implementado
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <h5>Historial de Iteraciones:</h5>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Iteración</th>
                        <th>xₖ</th>
                        <th>xₖ₊₁</th>
                        <th>Error Absoluto</th>
                        <th>Error Relativo</th>
                        <th>Error Porcentual</th>
                    </tr>
                </thead>
                <tbody>
                    {% for it in iteraciones %}
                    <tr>
                        <td>{{ it.iteracion }}</td>
                        <td>{{ it.x_prev|floatformat:6 }}</td>
                        <td>{{ it.x_act|floatformat:6 }}</td>
                        <td>{{ it.error_abs|floatformat:6 }}</td>
                        <td>{{ it.error_rel|floatformat:6 }}</td>
                        <td>{{ it.error_porcentual|floatformat:6 }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<div class="card mt-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0">Teoría del Método de Estimación del Error</h5>
    </div>
    <div class="card-body">
        <p>El método de punto fijo con estimación iterativa del error se basa en la iteración:</p>
        <p class="text-center">x<sub>k+1</sub> = g(x<sub>k</sub>)</p>
        
        <p>El error en cada iteración se estima como:</p>
        <ul>
            <li>Error absoluto: |x<sub>k+1</sub> - x<sub>k</sub>|</li>
            <li>Error relativo: |x<sub>k+1</sub> - x<sub>k</sub>| / |x<sub>k+1</sub>|</li>
            <li>Error porcentual: Error relativo × 100%</li>
        </ul>
        
        <p>El criterio de parada se alcanza cuando el error absoluto es menor que la tolerancia especificada:</p>
        <p class="text-center">|x<sub>k+1</sub> - x<sub>k</sub>| < ε</p>
        
        <p><strong>Condición de convergencia:</strong> El método converge si |g'(x)| < 1 en un intervalo que contiene a la solución.</p>
    </div>
</div>

<script>
    // Activar tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
</script>
{% endblock %}